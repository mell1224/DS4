using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Data.SqlClient;
using System.IO;

namespace Pedidos
{
    public partial class FormProducto : Form
    {
        ToolStripButton btnPedidos;
        ToolStripButton btnInventario;
        ToolStripButton btnRecetas;
        ToolStripButton btnProduccion;
        ToolStripButton btnProductos;

        private DataTable _productos;
        private DataTable _categorias;
        private int? _idProductoEnEdicion;
        private const int UMBRAL_STOCK_BAJO = 10;
     

        public FormProducto()
        {
            InitializeComponent();
            ConfigurarMenu();
            InicializarFormulario();
        }

        private void InicializarFormulario()
        {
            plNuevoProd.Visible = false;
            plEditProd.Visible = false;

            this.Load += FormProducto_Load;

            dtgProductos.AutoGenerateColumns = false;
            dtgProductos.CellContentClick += dtgProductos_CellContentClick;
            dtgProductos.CellClick += dtgProductos_CellClick;


            txtBuscarProd.TextChanged += txtBuscarProd_TextChanged;
            comboBox1.SelectedIndexChanged += comboBox1_SelectedIndexChanged;

            btnNuevoProducto.Click += btnNuevoProducto_Click;
            btnCanceProd.Click += btnCanceProd_Click;
            btnCanceEditProd.Click += btnCanceEditProd_Click;
            btnCrearProd.Click += btnCrearProd_Click;
            btnGuardCamb.Click += btnGuardCamb_Click;

            ConfigurarGrillaProductos();
        }

        // 1. M√©todo ConfigurarMenu

        private void ConfigurarMenu()
        {
            // Crear botones
            btnPedidos = new ToolStripButton("Pedidos");
            btnInventario = new ToolStripButton("Inventario");
            btnRecetas = new ToolStripButton("Recetas");
            btnProduccion = new ToolStripButton("Producci√≥n");
            btnProductos = new ToolStripButton("Productos");

            // Asignar eventos para abrir formularios
            btnPedidos.Click += (s, e) => AbrirFormulario(new FormPedido(), btnPedidos);
            btnInventario.Click += (s, e) => AbrirFormulario(new FormInventario(), btnInventario);
            btnRecetas.Click += (s, e) => AbrirFormulario(new FormReceta(), btnRecetas);
            btnProduccion.Click += (s, e) => AbrirFormulario(new FormProduccion(), btnProduccion);
            btnProductos.Click += (s, e) => AbrirFormulario(new FormProducto(), btnProductos);

            // Agregar botones al ToolStrip
            tsP.Items.AddRange(new ToolStripItem[]
            {
        btnPedidos, btnInventario, btnRecetas, btnProduccion, btnProductos
            });

            // Marcar el bot√≥n activo (Productos)
            MarcarBotonActivo(btnProductos);
        }

        // M√©todo para abrir formularios y ocultar el actual
        private void AbrirFormulario(Form destino, ToolStripButton botonActivo)
        {
            MarcarBotonActivo(botonActivo);
            destino.Show();
            this.Hide();
        }

        // M√©todo para resaltar el bot√≥n activo
        private void MarcarBotonActivo(ToolStripButton botonActivo)
        {
            foreach (ToolStripItem item in tsP.Items)
            {
                if (item is ToolStripButton btn)
                {
                    btn.BackColor = Color.White;
                    btn.ForeColor = SystemColors.ControlText;
                }
            }
            botonActivo.BackColor = ColorTranslator.FromHtml("#d96704");
            botonActivo.ForeColor = Color.White;
        }
        // 1. Evento dtgProductos_CellClick
        private void dtgProductos_CellClick(object sender, DataGridViewCellEventArgs e)
        {
            if (e.RowIndex < 0) return;
 
            // üëâ Click sobre la columna de imagen (Column1)
            if (dtgProductos.Columns[e.ColumnIndex].Name == "Column1")
            {
                OpenFileDialog ofd = new OpenFileDialog();
                ofd.Filter = "Im√°genes|*.jpg;*.jpeg;*.png;*.bmp;*.ico";
 
                if (ofd.ShowDialog() == DialogResult.OK)
                {
                    string ruta = ofd.FileName;
 
                    // Mostrar imagen en la grilla
                    dtgProductos.Rows[e.RowIndex].Cells["Column1"].Value = Image.FromFile(ruta);
 
                    // Guardar en BD
                    int id = Convert.ToInt32(dtgProductos.Rows[e.RowIndex].Cells["IdProducto"].Value);
                    GuardarImagenBD(id, ruta);
                }
            }
        }
 
 
        // 2. Evento dtgProductos_CellContentClick
        private void dtgProductos_CellContentClick(object sender, DataGridViewCellEventArgs e)
        {
            if (e.RowIndex < 0) return;
 
            // Editar
            if (dtgProductos.Columns[e.ColumnIndex].Name == "Column6")
            {
                MostrarPanelEditarProducto(e.RowIndex);
                return;
            }
 
            // Eliminar
            if (dtgProductos.Columns[e.ColumnIndex].Name == "Column7")
            {
                EliminarProducto(e.RowIndex);
                return;
            }
        }
 
        // M√©todo para guardar la ruta de la imagen en la base de datos
        private void GuardarImagenBD(int idProducto, string ruta)
        {
            try
            {
                using (SqlConnection cn = Conexion.ObtenerConexion())
                using (SqlCommand cmd = new SqlCommand("SP_ActualizarImagenProducto", cn))
                {
                    cmd.CommandType = CommandType.StoredProcedure;
 
                    cmd.Parameters.AddWithValue("@IdProducto", idProducto);
                    cmd.Parameters.AddWithValue("@ImagenURL", ruta);
 
                    cn.Open();
                    cmd.ExecuteNonQuery();
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Error al actualizar la imagen: " + ex.Message,
                                "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }
 
 


        // 3. Evento txtBuscarProd_TextChanged
        private void txtBuscarProd_TextChanged(object sender, EventArgs e)
        {
            AplicarFiltrosYMostrar();
        }

        // 4. Evento comboBox1_SelectedIndexChanged
        private void comboBox1_SelectedIndexChanged(object sender, EventArgs e)
        {
            AplicarFiltrosYMostrar();
        }

        // 5. Evento btnNuevoProducto_Click
        private void btnNuevoProducto_Click(object sender, EventArgs e)
        {
            plNuevoProd.Visible = true;
            plEditProd.Visible = false;
            txtNombProd.Text = "";
            txtDescrN.Text = "";
            nudPreNuev.Value = 0;
            nudIniNuev.Value = 0;
            cmbCategNuev.SelectedIndex = -1;
        }

        // 6. Evento btnCanceProd_Click
        private void btnCanceProd_Click(object sender, EventArgs e)
        {
            plNuevoProd.Visible = false;
        }

        // 7. Evento btnCanceEditProd_Click
        private void btnCanceEditProd_Click(object sender, EventArgs e)
        {
            plEditProd.Visible = false;
        }
      

        // 9. M√©todo ValidarNuevoProducto
        private bool ValidarNuevoProducto()
        {
            if (string.IsNullOrWhiteSpace(txtNombProd.Text))
            {
                MessageBox.Show("Ingrese el nombre del producto.", "Validaci√≥n", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return false;
            }
            if (cmbCategNuev.SelectedIndex < 0)
            {
                MessageBox.Show("Seleccione una categor√≠a.", "Validaci√≥n", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return false;
            }
            return true;
        }

        // 10. M√©todo ValidarProductoEdicion
        private bool ValidarProductoEdicion()
        {
            if (string.IsNullOrWhiteSpace(txtEditProd.Text))
            {
                MessageBox.Show("Ingrese el nombre del producto.", "Validaci√≥n", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return false;
            }
            if (cmbCategEdit.SelectedIndex < 0)
            {
                MessageBox.Show("Seleccione una categor√≠a.", "Validaci√≥n", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return false;
            }
            return true;
        }

        // M√©todo auxiliar para editar producto
        private void MostrarPanelEditarProducto(int rowIndex)
        {
            if (rowIndex < 0 || rowIndex >= dtgProductos.Rows.Count) return;

            DataGridViewRow fila = dtgProductos.Rows[rowIndex];
            if (fila.Cells["IdProducto"].Value == null) return;

            _idProductoEnEdicion = Convert.ToInt32(fila.Cells["IdProducto"].Value);
            txtEditProd.Text = fila.Cells["Column2"].Value?.ToString() ?? "";
            txtDescrEdit.Text = ""; // Asigna la descripci√≥n si est√° disponible
            nudPrecEdit.Value = fila.Cells["Column4"].Value != null ? Convert.ToDecimal(fila.Cells["Column4"].Value) : 0;
            nudIniEdit.Value = fila.Cells["Column5"].Value != null ? Convert.ToDecimal(fila.Cells["Column5"].Value) : 0;
            cmbCategEdit.SelectedIndex = cmbCategEdit.FindStringExact(fila.Cells["Categoria"].Value?.ToString() ?? "");

            plEditProd.Visible = true;
            plNuevoProd.Visible = false;
        }

        private void FormProducto_Load(object sender, EventArgs e)
        {
            CargarCategorias();
            CargarProductos();
        }
 
        private void ConfigurarGrillaProductos()
        {
            // üîπ Agregar columna IdProducto si no existe
            if (!dtgProductos.Columns.Contains("IdProducto"))
            {
                var colId = new DataGridViewTextBoxColumn();
                colId.Name = "IdProducto";
                colId.HeaderText = "IdProducto";
                colId.Visible = false;
                dtgProductos.Columns.Insert(0, colId);
            }
 
            // üîπ Configurar columna de imagen
            if (dtgProductos.Columns["Column1"] is DataGridViewImageColumn imgCol)
            {
                imgCol.ImageLayout = DataGridViewImageCellLayout.Zoom; // Ajusta la imagen proporcionalmente
                imgCol.Width = 120; // Ancho de columna
            }
 
            // üîπ Ajustar altura de filas autom√°ticamente seg√∫n contenido
            dtgProductos.AutoSizeRowsMode = DataGridViewAutoSizeRowsMode.AllCells;
            dtgProductos.RowTemplate.Height = 100; // Altura m√≠nima
 
            // üîπ Configurar columnas de botones
            Column6.Text = "Editar";
            Column6.UseColumnTextForButtonValue = true;
 
            Column7.Text = "Eliminar";
            Column7.UseColumnTextForButtonValue = true;
 
            // üîπ Configuraci√≥n general
            dtgProductos.SelectionMode = DataGridViewSelectionMode.FullRowSelect;
            dtgProductos.MultiSelect = false;
            dtgProductos.ReadOnly = false;
            dtgProductos.AllowUserToAddRows = false;
        }
 


        // ‚úÖ CARGAR CATEGOR√çAS CON SP
        private void CargarCategorias()
        {
            try
            {
                using (SqlConnection cn = Conexion.ObtenerConexion())
                using (SqlCommand cmd = new SqlCommand("SP_ListarCategorias", cn))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    using (SqlDataAdapter da = new SqlDataAdapter(cmd))
                    {
                        DataTable dt = new DataTable();
                        da.Fill(dt);
                        _categorias = dt;

                        DataTable dtFiltro = dt.Copy();
                        DataRow filaTodas = dtFiltro.NewRow();
                        filaTodas["IdCategoria"] = DBNull.Value;
                        filaTodas["Nombre"] = "Todas";
                        dtFiltro.Rows.InsertAt(filaTodas, 0);

                        comboBox1.DataSource = dtFiltro;
                        comboBox1.DisplayMember = "Nombre";
                        comboBox1.ValueMember = "IdCategoria";

                        DataTable dtNuev = dt.Copy();
                        DataTable dtEdit = dt.Copy();

                        cmbCategNuev.DataSource = dtNuev;
                        cmbCategNuev.DisplayMember = "Nombre";
                        cmbCategNuev.ValueMember = "IdCategoria";
                        cmbCategNuev.SelectedIndex = -1;

                        cmbCategEdit.DataSource = dtEdit;
                        cmbCategEdit.DisplayMember = "Nombre";
                        cmbCategEdit.ValueMember = "IdCategoria";
                        cmbCategEdit.SelectedIndex = -1;
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Error al cargar las categor√≠as: " + ex.Message,
                                "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        // ‚úÖ CARGAR PRODUCTOS CON SP
        private void CargarProductos()
        {
            try
            {
                using (SqlConnection cn = Conexion.ObtenerConexion())
                using (SqlCommand cmd = new SqlCommand("SP_ListarProductos", cn))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    using (SqlDataAdapter da = new SqlDataAdapter(cmd))
                    {
                        DataTable dt = new DataTable();
                        da.Fill(dt);
                        _productos = dt;
                    }

                    AplicarFiltrosYMostrar();

                    // En lugar de lblResumen, actualiza el t√≠tulo del formulario
                    this.Text = $"Productos cargados: {_productos?.Rows.Count ?? 0}";
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Error al cargar los productos: " + ex.Message,
                                "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }


        private void AplicarFiltrosYMostrar()
        {
            if (_productos == null) return;

            string texto = txtBuscarProd.Text.Trim().Replace("'", "''");
            List<string> filtros = new List<string>();

            if (!string.IsNullOrEmpty(texto))
            {
                filtros.Add($"(Nombre LIKE '%{texto}%' OR Categoria LIKE '%{texto}%')");
            }

            if (comboBox1.SelectedValue != null &&
                comboBox1.SelectedValue != DBNull.Value)
            {
                int idCat = Convert.ToInt32(comboBox1.SelectedValue);
                filtros.Add($"IdCategoria = {idCat}");
            }

            string filtroFinal = string.Join(" AND ", filtros);

            DataView dv = new DataView(_productos);
            dv.RowFilter = filtroFinal;

            MostrarEnGrid(dv);
        }

        private void MostrarEnGrid(DataView vista)
        {
            dtgProductos.Rows.Clear();

            foreach (DataRowView drv in vista)
            {
                DataRow row = drv.Row;

                int index = dtgProductos.Rows.Add();
                DataGridViewRow gr = dtgProductos.Rows[index];

                gr.Cells["IdProducto"].Value = row["IdProducto"];
                gr.Cells["Column2"].Value = row["Nombre"];
                gr.Cells["Categoria"].Value = row["Categoria"];
                gr.Cells["Column4"].Value = row["PrecioVenta"];
                gr.Cells["Column5"].Value = row["Stock"];

                Image img = null;
                object imgObj = row["ImagenURL"];
                if (imgObj != DBNull.Value && imgObj != null)
                {
                    string ruta = imgObj.ToString();
                    if (!string.IsNullOrWhiteSpace(ruta) && File.Exists(ruta))
                    {
                        try { img = Image.FromFile(ruta); } catch { img = null; }
                    }
                }

                gr.Cells["Column1"].Value = img;
            }
        }

        // ‚úÖ CREAR PRODUCTO CON SP
        private void btnCrearProd_Click(object sender, EventArgs e)
        {
            if (!ValidarNuevoProducto()) return;

            string nombre = txtNombProd.Text.Trim();
            string descripcion = txtDescrN.Text.Trim();
            decimal precio = nudPreNuev.Value;
            int stock = (int)nudIniNuev.Value;
            int idCategoria = Convert.ToInt32(cmbCategNuev.SelectedValue);
            string imagenUrl = null;

            try
            {
                using (SqlConnection cn = Conexion.ObtenerConexion())
                using (SqlCommand cmd = new SqlCommand("SP_InsertarProducto", cn))
                {
                    cmd.CommandType = CommandType.StoredProcedure;
                    cmd.Parameters.AddWithValue("@Nombre", nombre);
                    cmd.Parameters.AddWithValue("@Descripcion", descripcion);
                    cmd.Parameters.AddWithValue("@IdCategoria", idCategoria);
                    cmd.Parameters.AddWithValue("@PrecioVenta", precio);
                    cmd.Parameters.AddWithValue("@Stock", stock);
                    cmd.Parameters.AddWithValue("@ImagenURL",
                        string.IsNullOrEmpty(imagenUrl) ? (object)DBNull.Value : imagenUrl);

                    cn.Open();
                    cmd.ExecuteNonQuery();
                }

                MessageBox.Show("Producto creado correctamente.",
                                "Informaci√≥n", MessageBoxButtons.OK, MessageBoxIcon.Information);

                plNuevoProd.Visible = false;
                CargarProductos();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Error al crear el producto: " + ex.Message,
                                "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        // ‚úÖ EDITAR PRODUCTO CON SP

        private void btnGuardCamb_Click(object sender, EventArgs e)
        {
            if (!ValidarProductoEdicion()) return;

            int idProducto = _idProductoEnEdicion.Value;
            string nombre = txtEditProd.Text.Trim();
            string descripcion = txtDescrEdit.Text.Trim();
            decimal precio = nudPrecEdit.Value;
            int stock = (int)nudIniEdit.Value;
            int idCategoria = Convert.ToInt32(cmbCategEdit.SelectedValue);
            string imagenUrl = null;

            try
            {
                using (SqlConnection cn = Conexion.ObtenerConexion())
                using (SqlCommand cmd = new SqlCommand("SP_ActualizarProducto", cn))
                {
                    cmd.CommandType = CommandType.StoredProcedure;

                    cmd.Parameters.AddWithValue("@IdProducto", idProducto);
                    cmd.Parameters.AddWithValue("@Nombre", nombre);
                    cmd.Parameters.AddWithValue("@Descripcion", descripcion);
                    cmd.Parameters.AddWithValue("@IdCategoria", idCategoria);
                    cmd.Parameters.AddWithValue("@PrecioVenta", precio);
                    cmd.Parameters.AddWithValue("@ImagenURL", string.IsNullOrEmpty(imagenUrl) ? (object)DBNull.Value : imagenUrl);
                    cmd.Parameters.AddWithValue("@Activo", 1); // ‚úÖ Se agreg√≥ este par√°metro

                    cn.Open();
                    cmd.ExecuteNonQuery();
                }

                MessageBox.Show("Producto actualizado correctamente.",
                    "Informaci√≥n", MessageBoxButtons.OK, MessageBoxIcon.Information);

                plEditProd.Visible = false;
                CargarProductos();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Error al actualizar el producto: " + ex.Message,
                    "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }


        // ‚úÖ ELIMINAR PRODUCTO CON SP
        private void EliminarProducto(int rowIndex)
        {
            if (rowIndex < 0 || rowIndex >= dtgProductos.Rows.Count) return;

            DataGridViewRow fila = dtgProductos.Rows[rowIndex];
            if (fila.Cells["IdProducto"].Value == null) return;

            int idProducto = Convert.ToInt32(fila.Cells["IdProducto"].Value);
            string nombre = fila.Cells["Column2"].Value?.ToString() ?? "";

            DialogResult dr = MessageBox.Show(
                $"¬øSeguro que deseas eliminar el producto \"{nombre}\"?",
                "Confirmar eliminaci√≥n",
                MessageBoxButtons.YesNo,
                MessageBoxIcon.Question);

            if (dr != DialogResult.Yes) return;

            try
            {
                using (SqlConnection cn = Conexion.ObtenerConexion())
                using (SqlCommand cmd = new SqlCommand("SP_EliminarProducto", cn))
                {
                    cmd.CommandType = CommandType.StoredProcedure;
                    cmd.Parameters.AddWithValue("@IdProducto", idProducto);
                    cn.Open();
                    cmd.ExecuteNonQuery();
                }

                MessageBox.Show("Producto eliminado correctamente.",
                                "Informaci√≥n", MessageBoxButtons.OK, MessageBoxIcon.Information);

                CargarProductos();
            }
            catch (Exception ex)
            {
                MessageBox.Show("No se pudo eliminar el producto. Verifique dependencias.\n\nDetalle: " + ex.Message,
                                "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void btnSalir_Click(object sender, EventArgs e)
        {
            this.Close();
            FormLogin fl = new FormLogin();
            fl.Show();
        }
    }
}
 
 
